#!/usr/bin/env bash

__DIR__="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

[ -f "$__DIR__/.env" ] && source "$__DIR__/.env"
[ -z "$MINISH_DEPLOY_DST" ] && { echo "ERROR: 'MINISH_DEPLOY_DST' is not defined and no '.env' file."; exit 1; }

SRC="$__DIR__/../"
DST="${MINISH_DEPLOY_DST%/}/"

[ "$1" == "y" ] && REPLY="y"


ask_yesno() {
  REPLY=
  printf "$1 (y/n) "
  while [ -z "$REPLY" ]; do
    read -n 1
    [[ "${REPLY,,}" =~ ^(y|n)$ ]] \
      && { [ "${REPLY,,}" == "y" ] || REPLY="n"; } \
      || { [ -n "$REPLY" ] && echo; REPLY=; printf "y or n? "; }
  done
  echo
}

exec_rsync() {
  rsync "$@" -au --delete --out-format="%o %n" --include-from="$__DIR__/.deploy-files" "$SRC" "$DST"
}


find "$SRC" -name .DS_Store -delete

"$__DIR__/sass" deploy

if [ "$REPLY" != "y" ]; then
  output=$(exec_rsync --dry-run)
  [ -z "$output" ] && { echo "Nothing changed."; exit 0; }

  echo -e "\033[37m\033[1mThe following would be executedâ€¦\033[0m\n$output\n"

  ask_yesno "\033[37m\033[1mDo you want to execute this?\033[0m"
fi

[ "$REPLY" == "y" ] && exec_rsync --progress
